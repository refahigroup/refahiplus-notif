stages:
  - build
  - docker
  - notify

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "staging" || $CI_COMMIT_BRANCH == "dev"'
      when: always
    - when: never

variables:
  SOLUTION: "Refahi.Notif.sln"
  API_CSPROJ: "src/Refahi.Notif.EndPoint.Api/Refahi.Notif.EndPoint.Api.csproj"
  SERVICE_NAME: "notif"

  PUBLISH_DIR: "publish"

default:
  cache:
    key: "nuget-${CI_PROJECT_ID}"
    paths:
      - .nuget/packages

build_publish:
  stage: build
  image: registry.refahi.xyz/refahi-devops/ci-cache/dotnet-sdk:10.0
  script:
    - echo "Branch=$CI_COMMIT_BRANCH"

    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        ENV="prod"
      elif [ "$CI_COMMIT_BRANCH" = "staging" ]; then
        ENV="stage"
      else
        ENV="dev"
      fi
      echo "ENV=$ENV" > build.env
      echo "SERVICE_NAME=$SERVICE_NAME" >> build.env

    - |
      BUILD_VERSION="${ENV}-${CI_PIPELINE_IID}-${CI_COMMIT_SHORT_SHA}"
      echo "BUILD_VERSION=$BUILD_VERSION" >> build.env

    - dotnet restore "./$SOLUTION" --packages .nuget/packages
    - dotnet build "./$SOLUTION" -c Release --no-restore

    - dotnet publish "./$API_CSPROJ" -c Release --no-build --output "./$PUBLISH_DIR"

  artifacts:
    expire_in: 1 day
    paths:
      - $PUBLISH_DIR
    reports:
      dotenv: build.env

docker_build_push:
  stage: docker
  image: registry.refahi.xyz/refahi-devops/ci-cache/docker:27
  needs:
    - job: build_publish
      artifacts: true
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"  
  script:
    - docker version
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - export IMAGE_ENV="$CI_REGISTRY_IMAGE:$ENV"
    - export IMAGE_VER="$CI_REGISTRY_IMAGE:$BUILD_VERSION"
    - docker build -f ./src/Refahi.Notif.EndPoint.Api/Dockerfile -t "$IMAGE_ENV" -t "$IMAGE_VER" .
    - docker push "$IMAGE_ENV"
    - docker push "$IMAGE_VER"

notify_deploy_agent:
  stage: notify
  image: curlimages/curl:8.6.0
  needs:
    - job: build_publish
      artifacts: true
    - job: docker_build_push
  rules:
    - if: '$DEPLOY_AGENT_URL && $DEPLOY_AGENT_TOKEN'
      when: on_success
    - when: never
  script:
    - |
      echo "Notify deploy-agent: service=$SERVICE_NAME env=$ENV"
      curl -sS -X POST "$DEPLOY_AGENT_URL" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $DEPLOY_AGENT_TOKEN" \
        --data "{\"service\":\"$SERVICE_NAME\",\"env\":\"$ENV\"}" \
        --max-time 180
